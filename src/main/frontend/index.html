<!DOCTYPE html> 
<html> 
<head> 
	<title>Appening Amsterdam</title> 
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css" />
		<link rel="stylesheet" href="jqm.css" />

	<script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="jquery.ui.map.min.js"></script>

</head> 
<body> 

<div data-role="page" class="type-interior" id="main">

<div data-role="header" data-theme="b">
		<h1>Appening Amsterdam</h1>
	</div><!-- /header -->


	<div data-role="content">
	
		<div class="content-primary">

	<p>
	<strong>Welcome to Appening Amsterdam</strong>, the event calender generated from social media <a href="">learn more</a>
	</p>
	
	<br />
	<div id="map_canvas"></div>
				
			
      </div>
		<!--/content-primary -->

				<div class="content-secondary">
				
						<ul id="places" data-role="listview" data-inset="false" data-filter="true">
	

						</div> <!-- /content-secondary -->	

			</div><!-- /content -->
			
		<div data-role="footer" class="footer-docs" data-theme="c">
		<p>TODO</p>
	</div>

			</div><!-- /page -->
			
			
			
			
<div data-role="page" class="type-interior" id="details" data-title="Stedelijk Museum">

<div data-role="header" data-theme="b">
	<a href="#main" data-role="button" data-icon="home">Home</a>

		<h1>TITLE</h1>
	</div><!-- /header -->


	<div data-role="content">
	
		<div class="content-primary">

			
      </div>
		<!--/content-primary -->

				<div class="content-secondary">
				
						<ul id="details-places" data-role="listview" data-inset="false">

							</ul>

						</div> <!-- /content-secondary -->	

			</div><!-- /content -->
			
			<div data-role="footer" class="footer-docs" data-theme="c">
		<p>TODO</p>
	</div>

			</div><!-- /page -->
			
<script type="text/javascript">

var places = [];


function dist(lat1,lon1,lat2,lon2) {
	var R = 6371; // km
	var dLat = (lat2-lat1).toRad();
	var dLon = (lon2-lon1).toRad();
	var lat1 = lat1.toRad();
	var lat2 = lat2.toRad();
	
	var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
			Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2); 
	var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
	var d = R * c;
	return d;
}

$('#main').live('pageinit', function() {
	if($('#map_canvas').css('display') == 'none') {
	return;
	}
	$('#map_canvas').gmap({ 'center': '52.3741,4.897' , 'callback': function(map) {
					var self = this;
						navigator.geolocation.watchPosition(function(position, status) {
							if ( position != undefined ) {
							
								var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
								if ( !self.get('markers').client ) {
									self.addMarker({ 'id': 'client', 'position': latlng, 'bounds': true });
								} else {
									self.get('markers').client.setPosition(latlng);
									map.panTo(latlng);
								}
							}
						});
					}});
				});
						


$(document).bind( "pagebeforechange", function( e, data ) {
	if ( typeof data.toPage !== "string" ) {
		return;
	}
	
		var u = $.mobile.path.parseUrl( data.toPage );
var idregex = /-([\d]+)$/;
var showPlaceId = undefined;
if (idregex.test(u.hash)) {
	showPlaceId = u.hash.match(idregex)[1];
}
		if (showPlaceId == undefined) {
			return;	
		}
		
		var splace = undefined;
				var items=[];
				
				

		$.each(places,function(index,place) {
		var dt = "";
			if (place.id == showPlaceId) {
				splace = place;
				dt = 'data-theme="a"'
			}
			if (place.trend.rank < 1) {
				return;
			}
			 var line = '<li '+dt+'><a id="'+place.id+'" href="#'+encodeURIComponent(place.name)+'-'+place.id+'">'+place.name+'</a></li>';
    		items.push(line);

		});
		
		if (splace == undefined) {
			return;
		}
		var page = $('#details');
		page.find("h1").html(splace.name);
				


if (items.length > 0) {
 $('#details-places').html(items.join('\n'));
 }

				
		data.options.dataUrl = u.href;
		$.mobile.changePage( page, data.options );
		  $('#details-places').listview('refresh');

		e.preventDefault();

});


$('#main').live('pageinit', function() {		
(function worker() {
$.getJSON('data/places.json', function(data) {
places = data;
var items=[];
$.each(data,function(index,place) {
if (place.trend.rank < 1) {
return;
}
  var line = '<li><a id="'+place.id+'" href="#'+encodeURIComponent(place.name)+'-'+place.id+'">'+place.name+' <span class="ui-li-count">'+place.trend.rank.toFixed(0)+'</span></a></li>';
    items.push(line);
});

if (items.length > 0) {
 $('#places').html(items.join('\n')).listview('refresh');

  }
 
 setTimeout(worker, 1*60*1000); // 1 min

});
})();


});

</script>

</body>
</html>