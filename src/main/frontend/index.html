<!DOCTYPE html> 
<html><head><title>Appening Amsterdam</title>
	<meta charset="utf-8">
    <link href="bootstrap.min.css" rel="stylesheet">
       <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
    </style>
</head>

<body>

  <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="#">Appening Amsterdam</a>
        </div>
      </div>
    </div>

    <div class="container">

		<table id="places" class="table">
		</table>
		
		<div id="map_canvas"></div>
    </div> 


<!--<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyCHCVlEq_VleQp6qKdOpPgGT1W1h3yG29s&sensor=false">-->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
    <script src="bootstrap.min.js"></script>

<!--<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyCHCVlEq_VleQp6qKdOpPgGT1W1h3yG29s&sensor=false">-->

<script type="text/javascript">


function slope(pointsArr) {	
	if (pointsArr.length < 2) {
		return 0;
	}
		
	// fitted curve: y=a+b*x
	// a= (sum(y)*sum(x^2) - sum(x)*sum(x*y))  / (n*sum(x^2)-(sum(x))^2)
	// b = (n*sum(x*y) - sum(x)*sum(y)) / (n*sum(x^2)-(sum(x))^2)
	
	// http://www.efunda.com/math/leastsquares/lstsqr1dcurve.cfm
	var sx2 = 0;
	var sx = 0;
	var sy = 0;
	var sxy = 0;
	var n = pointsArr.length;
    $.each(pointsArr,function(x,y){
    	sx2+=Math.pow(x,2);
    	sx+=x;
    	sy+=y;
    	sxy+=x*y;
    });

	var denom = n*sx2-Math.pow(sx,2);
	//$a = ($sy*sx2 - $sx*$sxy) / $denom; // not interesting?
	var b = (n*sxy - sx*sy) / denom;
	return b;
}


function lastHours(pointsArr,maxHours) {
	var h = [];
	 $.each(pointsArr,function(x,y){
	 	if (x < maxHours) {
	 		h[x] = y;
	 	}
	 });
	return h;
}

function generateTrend(pointsArr,maxHours) {
 	var data = lastHours(pointsArr,maxHours);
    var s = slope(data);
    var n = 0;
    $.each(data,function(x,y){n+=y});
	return {'n':n,'s':s};
}

function trendFigure(trend) {
    var s = trend.s;
    var n = trend.n;
    
    if (n < 2) {
    	return '<td style="color:gray;">-</td>';
    }
    var color = 'black';
    var prefix = '+';
    if  (s <0) {
		color = 'red';
		prefix = ''
    }
    
    return '<td><span style="color:'+color+';">'+prefix+''+s.toFixed(2)+'</span> <small>(n='+n+')</small></td>';
}


(function worker() {
$.getJSON('places.json', function(data) {
$.each(data,function(index,place) {
	// calculate the mentioned time series 48h back
	var mts = [];
    for (var h = 0; h <= 48; h++) {
    	if (place.mentions[h] != undefined) {
    		mts[h] = place.mentions[h];
    	} else {
    		mts[h] = 0;
    	}
    }
 //   mts = mts.reverse();
    var sum = 0;
    $.each(mts,function(i,v){sum+=v});
    
    place.sum = sum;
    place.mentionsSeries = mts;
    
    place.trend = {};
    place.trend.h48 = generateTrend(mts,48);
    place.trend.h24 = generateTrend(mts,24);
    place.trend.h12 = generateTrend(mts,12);
    place.trend.h6 = generateTrend(mts,6);
    place.trend.h3 = generateTrend(mts,3);

	place.trend.rank = place.trend.h6.n *  place.trend.h6.s + 5 * place.trend.h3.n *  place.trend.h3.s;  
    
    
    
});

data.sort(function(a,b) {
        return (a.trend.rank < b.trend.rank) ? 1 : (a.trend.rank > b.trend.rank) ? -1 : 0;
});

  var items = [];

$.each(data,function(index,place) {
if (place.sum < 10 ||Â place.trend.rank <= 0) {
    	return;
    }
    
 var line  = "<tr>";
    line += '<td title="'+place.id+'"><b>'+place.name+'</b></td>';
    
	// make copy here, because reverse operates in-place
	var chartSeries = place.mentionsSeries.slice().reverse();
    line += '<td><img src="http://chart.googleapis.com/chart?cht=ls&chxr=0,0,72&chxs=0,676767,0,0,_,676767&chm=D,0033FF,0,0,1,1&chs=200x50&chds=a&chd=t:'+ chartSeries.join(',') +'&chxt=x,y" /></td>';
    
    
    line += trendFigure(place.trend.h48);
    line += trendFigure(place.trend.h24);
    line += trendFigure(place.trend.h12);
    line += trendFigure(place.trend.h6);
	line += trendFigure(place.trend.h3);

   line += '<td>'+place.trend.rank.toFixed(2)+'</td>';

    line += '</tr>';
    

    items.push(line);

});

if (items.length > 0) {
 $('#places').html(items.join('\n'));

}
else {
 	 $('#places').html('<tr><td>Sorry, nothing "appening" right now! Come back later...</td></tr>');
 }
 


 
     setTimeout(worker, 5000);

 
});
})();

/*
var mapOptions = {
          center: new google.maps.LatLng(52.3704,4.895),
          zoom: 15,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var map = new google.maps.Map(document.getElementById("map_canvas"),
            mapOptions);
*/
            
</script>

</body>
</html>

